---
title: "elephants-8-pilot"
author: "MH Tessler"
date: "2/22/2019"
output: github_document
---

[Link to experiment (all condition)](https://www.mit.edu/~karengu/elephants_all/elephants/experiments/elephants-8.html)

## Experiment 8 Pilot

Based on elephants-3.

* VP coordination 
* most vs. all vs. some
* conditions
    + interrupted, ME (1)
    + uninterrupted, ME (2)
    + interrupted, NME (3)
    + uninterrupted, NME (4)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F, fig.width = 10)
library(tidyverse)
library(knitr)
library(ggthemes)
library(jsonlite)
library(viridis)
library(tidyboot)
library(ggpirate)
theme_set(theme_few())
data.path <- "../../data/elephants-8/"
```

## Subject Information

```{r, echo=F, warning=F}
results.path <- data.path
anon_results = list.files(data.path)

i = 0
df.subject <- data.frame()
df.trials <- data.frame()
df.attention <- data.frame()
for (anon_result in anon_results) {
  
  result_json = fromJSON(paste(data.path, anon_result, sep ="/"))

  df.attention = bind_rows(
    df.attention, 
    data.frame(result_json$answers$catch_trials) %>%
    mutate(
      workerid = i
      )
  )
  
  df.subject = bind_rows(
    df.subject, 
    data.frame(result_json$answers$subject_information) %>% 
      mutate(workerid = i)
  )
  
  df.trials = bind_rows(
    df.trials, 
    data.frame(result_json$answers$trials) %>% 
      mutate(workerid = i)
  )

  i = i + 1
}
```


```{r}
df.subject %>%
  select(workerid, language, enjoyment, age, gender, problems, comments) %>%
  kable(.)
```

## Attention Checks 

### Slider Practice

Before the experiment, participants practice using the sliders to rate 3 category-property pairs:

- dogs bark (coded as correct if x > 0.5)
- birds are male (coded as correct if 0.25 < x < 0.75)
- cats get cancer (coded as correct if x < 0.75) [being generous with this one]
- lions lay eggs (coded as correct if x < 0.10)

```{r}
df.slider_check <- df.attention %>% 
  filter(condition == "practice") %>%
  mutate(correct = case_when(
    property == "dogs bark" ~ response > 0.5,
    property == "birds are male" ~ response > 0.25 & response < 0.75,
    property == "cats get cancer" ~ response < 0.75,
    property == "lions lay eggs" ~ response < 0.3
  )) 

df.slider_check.workers <- df.slider_check %>%
  group_by(workerid) %>% 
  summarize(
    n_correct = sum(correct),
    not_all_correct = n_correct < 4,
    not_three_correct = n_correct < 3
    )

workers.fail.sliders <- df.slider_check.workers %>%
  filter(not_all_correct) %>%
  pull(workerid)

# worker 44 failed to respond to last slider, but they got wrong one other slider
workers.fail.sliders <- c(workers.fail.sliders, 44)

# number of participants that got a certain number of properties correct
df.slider_check %>% 
  group_by(workerid) %>%
  summarize(n_correct = sum(correct)) %>%
  group_by(n_correct) %>% count() %>%
  kable()

# number of participants that got each property correct
df.slider_check %>% 
  group_by(property) %>%
  summarize(n_correct = sum(correct, na.rm = TRUE)) %>%
  kable()
```

A greater number of participants failed on the "lions lay eggs" check. Considering their explanations, this seems to be simply because the range of accepted responses for "lions lay eggs" is smaller. Most of the explanations didn't seem to convey that the participant had actually paid attention.
```{r}
df.attention %>%
  filter(condition == "practice", property == "lions lay eggs", response >= 0.1) %>%
  select(property, response, workerid) %>%
  left_join(df.attention %>% filter(correct == -1), by = "workerid") %>%
  select(property.x, response.x, workerid, property.y) %>%
  kable()
```

### Memory Check

After the story, participants select statements they recall learning from a list of 10 generic statements about novel animals (5 true, 5 distractor).

```{r}
df.mmry <- df.attention %>%
  filter(condition == "memory_check") %>%
  mutate(correct = as.numeric(correct)) %>%
  group_by(workerid, tested_on) %>%
  summarize(n_correct = sum(correct)) %>%
  ungroup() %>%
  spread(tested_on, n_correct) %>%
  rename(correct_rejections = `0`, 
         hits = `1`) %>%
  mutate(n_correct = correct_rejections + hits) 

#workers.fail.memory <- df.mmry %>% filter(n_correct < 7) %>% pull(workerid)
workers.fail.memory <- c()#df.mmry %>% filter(correct_rejections < 4) %>% pull(workerid)

ggplot(df.mmry, aes( x = correct_rejections ))+
  geom_bar()+
  #xlab("n correctly recognized (or correctly rejected)")+
  #scale_x_continuous(limits = c(0, 10.5), breaks = c(0, 4, 5, 6, 7, 8, 9, 10))+
  ylab("n participants")
```

### Explanations of Task

After the story, participants are also asked to explain generally what they did in the experiment.

```{r}
df.expln <- df.attention %>%
  filter(correct == -1) %>%
  left_join(., df.mmry %>% select(workerid, n_correct) %>%
              rename(n_memory_correct = n_correct)) %>%
  left_join(., df.slider_check.workers %>% select(workerid, n_correct) %>%
              rename(n_slider_correct = n_correct))

bad.expln <- c(9, 12, 16, 20, 21, 24, 28, 37, 38, 43, 49, 51, 57, 67, 70, 74, 82, 84, 86, 89, 90, 97, 101, 102, 107)
df.expln %>%
  select(workerid,n_slider_correct,  n_memory_correct, property) %>%
  rename(explanation = property) %>%
  kable(.)
```

## Participants

### Number of Participants by Item and Condition

```{r}
df.full.tab.item.count <-  df.trials %>% filter(condition ==  "uninterrupted", trial_type == "critical", page_type == "query") %>%
  group_by(quantifier, predicate_1) %>%
  count() %>%
  spread(quantifier, n) 

df.full.tab.item.count %>% kable()

df.full.tab.item.count %>% 
  gather(quantifier, n, all, generic, most) %>%
  group_by(quantifier) %>%
  summarize(n = sum(n)) %>% kable()
```

### Included/Excluded Subject Numbers
Removing participants who didn't get all 4 sliders. (All participants with bad explanations failed one or more sliders.)

```{r}
df.trials <- df.trials %>%
  mutate(memory_fail = workerid %in% workers.fail.memory,
      slider_fail = workerid %in% workers.fail.sliders,
      bad_expln  = workerid %in% bad.expln) %>%
  left_join(., 
      df.mmry %>% select(workerid, n_correct)
)

df.query <- df.trials %>%
  filter(page_type == "query") %>%
  gather(key, val, response_1, response_2)

df.query %>%
  distinct(workerid, memory_fail, slider_fail, bad_expln) %>%
  group_by(memory_fail, slider_fail) %>% count() %>% kable()
```

### Prevalence Estimates by Participant
 
Histogram of all of a single participant's prevalence estimates, collapsed across trials and color coded for the number of correct responses on the memory check.  
* fill = number of correct responses on the memory check (out of 10)  
* facet = participants  

```{r fig.height = 10}
df.query  %>%
  ggplot(., aes( x = val, fill = n_correct ))+
  geom_histogram()+
  facet_wrap(~workerid)+
  scale_fill_viridis()+
  scale_x_continuous(breaks = c(0, 0.5, 1))
```

## Filler Trials

These used quantifiers (and thus we have strong idea about literal meaning).

```{r}
df.query.filler <- df.query %>%
  filter(!memory_fail, !slider_fail) %>%
  filter(trial_type == "filler") %>%
  select(workerid, condition, chapter_num, 
         rt, trial_type, quantifier, page_type, key, val)

df.query.filler  %>%
  ggplot(., aes( x = val ))+
  geom_histogram()+
  facet_wrap(~quantifier + condition)
```

## Critical Trials (collapsed across item)

### Histograms of Prevalence Estimates by Condition and Quantifier (collapsed across item)

```{r fig.height = 10}
df.query.critical <- df.query %>%
  filter(!memory_fail, !slider_fail) %>%
  select(workerid, condition, chapter_num, rt, 
         quantifier,
         trial_type, predicate_1, predicate_2, 
         key, val, page_type, memory_fail, slider_fail) %>%
  filter(trial_type == "critical") %>%
  rowwise() %>%
  mutate(condition = factor(condition, 
                            levels = c("interrupted", 
                                       "uninterrupted",
                                       "nme_interrupted",
                                       "nme_uninterrupted"),
                            labels = c('"...live in Africa __"\nQ2(Asia)',
                                       '"...live in Africa and Asia"\nQ2(Asia)',
                                       '"...live in Africa __"\nQ2(bugs)',
                                       '"...live in Africa and eat bugs"\nQ2(bugs)')),
         key = factor(key, levels = c("response_1", "response_2"),
                      labels = c("% live in Africa", "% property 2")))

df.query.critical %>%
  ggplot(., aes( x = val ))+
  geom_histogram()+
  facet_grid(quantifier + condition ~ key)
```

### Pirate Plots by Condition and Quantifier (collapsed across item)

```{r}
df.bs.query.critical <- df.query.critical %>%
  group_by(quantifier, condition, key) %>%
  tidyboot_mean(column = val)
  
ggplot(df.bs.query.critical, aes( x = condition, fill = key))+
  geom_hline(yintercept = 0.5, lty = 2, alpha = 0.5)+
  geom_point(data = df.query.critical, position = position_jitterdodge(),
             inherit.aes = F, aes(x = condition, y = val, color = key), 
             alpha = 0.5)+
  geom_col(position = position_dodge(0.8),
           aes(y = mean),
           width = 0.8, alpha = 0.3, color = 'black')+
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), 
                position = position_dodge(0.8), width = 0.3, size = 1.2)+  
  ylab("Implied prevalence rating")+
  facet_wrap(~quantifier)+
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1))+
  scale_fill_manual(values = c("#268bd2", "#859900"))+
  scale_color_manual(values = c("#268bd2", "#859900"))+
  xlab("")+
  guides(fill = guide_legend(title = "Question"),
         color = guide_legend(title = "Question"))+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
        legend.position = "top")
```

### Histograms of Prevalence Estimates by Quantifier for Condition 2 (collapsed across item)

```{r}
df.query.critical %>%
  filter(#quantifier %in% c("most", "generic",),
         condition ==  "\"...live in Africa and Asia\"\nQ2(Asia)") %>%
  mutate(quantifier = factor(quantifier, levels = c("generic", "most", "all")),
          key = factor(key, levels = c("% live in Africa", "% property 2"),
                       labels = c("% live in Africa", "% live in Asia"))) %>%
  ggplot(., aes( x = val ))+
  theme_black()+
  geom_histogram(color = 'white')+
  facet_grid( quantifier~ key, scales = 'free')+
  theme(strip.text.y = element_text(angle = 0))+
  scale_x_continuous(limits = c(-0.05, 1.05), breaks = c(0, 0.5, 1))+
  labs(
    x = "Implied prevalence rating",
    y = "Number of responses"
  )

#ggsave("~/Documents/talks/1904-bochum-elephants/expt3_withQuantifiers.pdf",
       #width = 8, height = 5)
```

## By-item Analyses

### Number of Participants by Item and Quantifier

```{r}
df.tab.item.count <-  df.query.critical %>% filter(condition ==  "\"...live in Africa and Asia\"\nQ2(Asia)", str_detect(key, "Africa")) %>%
  group_by(quantifier, predicate_1) %>%
  count() %>%
  spread(quantifier, n) 

df.tab.item.count %>% kable()

df.tab.item.count %>% 
  gather(quantifier, n, all, generic, most) %>%
  group_by(quantifier) %>%
  summarize(n = sum(n)) %>% kable()
```

## Pirate Plots (by item)

```{r fig.width=13, fig.height = 10}
df.bs.cond2.item <- df.query.critical %>%
  filter(#quantifier %in% c("most", "generic",),
         condition ==  "\"...live in Africa and Asia\"\nQ2(Asia)") %>%
  group_by(quantifier, condition, predicate_1, key) %>%
  tidyboot_mean(column = val)


ggplot(df.bs.cond2.item, aes( x = key, fill = key))+
  geom_hline(yintercept = 0.5, lty = 2, alpha = 0.5)+
  # geom_col(position = position_dodge(0.8),
  #          aes(y = mean),
  #          width = 0.8, alpha = 0.3, color = 'black')+
  # geom_linerange(aes(ymin = ci_lower, ymax = ci_upper), 
  #               position = position_dodge(0.8), width = 0.3, size = 1, alpha = 0.5)+  
  geom_point(data = df.query.critical %>% filter(condition ==  "\"...live in Africa and Asia\"\nQ2(Asia)"), 
             #position = position_jitterdodge(),
              #position = position_dodge(0.5),
             inherit.aes = F, aes(x = key, y = val, color = key), 
             alpha = 0.8)+
  geom_line(data = df.query.critical %>% filter(condition ==  "\"...live in Africa and Asia\"\nQ2(Asia)"), 
           #  position = position_jitterdodge(),
            position = position_dodge(),
             inherit.aes = F, aes(x = key, y = val, group = workerid), 
             alpha = 0.6)+
  ylab("Implied prevalence rating")+
  facet_wrap(~predicate_1 + quantifier, ncol = 9)+
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1))+
  scale_fill_manual(values = c("#268bd2", "#859900"))+
  scale_color_manual(values = c("#268bd2", "#859900"))+
  xlab("")+
  guides(fill = guide_legend(title = "Question"),
         color = guide_legend(title = "Question"))+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
        legend.position = "top")
```

```{r}
ggplot(df.bs.cond2.item, aes( x = quantifier, fill = key))+
  geom_hline(yintercept = 0.5, lty = 2, alpha = 0.5)+
  # geom_col(position = position_dodge(0.8),
  #          aes(y = mean),
  #          width = 0.8, alpha = 0.3, color = 'black')+
  # geom_linerange(aes(ymin = ci_lower, ymax = ci_upper), 
  #               position = position_dodge(0.8), width = 0.3, size = 1, alpha = 0.5)+  
  geom_point(data = df.query.critical %>% filter(condition ==  "\"...live in Africa and Asia\"\nQ2(Asia)"), 
             position = position_jitterdodge(),
              #position = position_dodge(0.5),
             inherit.aes = F, aes(x = quantifier, y = val, color = key), 
             alpha = 0.8)+
  ylab("Implied prevalence rating")+
  facet_wrap(~predicate_1, nrow = 2)+
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1))+
  scale_fill_manual(values = c("#268bd2", "#859900"))+
  scale_color_manual(values = c("#268bd2", "#859900"))+
  xlab("")+
  guides(fill = guide_legend(title = "Question"),
         color = guide_legend(title = "Question"))+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
        legend.position = "top")
```

### Histograms of Prevalence Estimates by Item

#### % live in Africa

```{r fig.height = 10}
df.query.critical %>%
  filter(condition ==  "\"...live in Africa and Asia\"\nQ2(Asia)",
         key == "% live in Africa") %>%
  ggplot(., aes( x = val ))+
  xlab("% live in Africa") +
  geom_histogram()+
  facet_grid( predicate_1 ~condition+ quantifier , scales = 'free')+
  theme(strip.text.y = element_text(angle = 0))
```

#### % live in Asia

```{r fig.height = 10}
df.query.critical %>%
  filter(condition ==  "\"...live in Africa and Asia\"\nQ2(Asia)",
         key == "% property 2") %>%
  ggplot(., aes( x = val ))+
  xlab("% property 2") + 
  geom_histogram()+
  facet_grid( predicate_2 ~condition+ quantifier , scales = 'free')+
  theme(strip.text.y = element_text(angle = 0))
```