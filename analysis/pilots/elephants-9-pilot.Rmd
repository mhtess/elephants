---
title: "elephants-9-pilot"
author: "Karen Gu"
date: "2/22/2019"
output: github_document
---

[Link to experiment (VP)](https://www.mit.edu/~karengu/elephants_vp/elephants/experiments/elephants-9.html)

## Experiment 9 Pilot

Acceptability task using a sliding scale (0-100%), where participants rate items of the form Elephants live in Africa and Asia.
* between-subjects: VP vs. NP coordination  
* within-subjects: generic vs. most vs. all  
* 30 trials per subject (10 generic, 10 most, 10 all)  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F, fig.width = 10)
library(tidyverse)
library(knitr)
library(ggthemes)
library(jsonlite)
library(viridis)
library(tidyboot)
library(ggpirate)
library(lme4)
library(lmerTest)
theme_set(theme_few())
data.path <- "../../data/elephants-9/"
```

## Subject Information

```{r, echo=F, warning=F}
results.path <- data.path
anon_results = list.files(data.path)

i = 0
df.subject <- data.frame()
df.trials <- data.frame()
df.attention <- data.frame()
for (anon_result in anon_results) {
  
  result_json = fromJSON(paste(data.path, anon_result, sep ="/"))

  df.attention = bind_rows(
    df.attention, 
    data.frame(result_json$answers$catch_trials) %>%
    mutate(
      workerid = i,
      property = gsub("\n", " ", property)
      )
  )
  
  df.subject = bind_rows(
    df.subject, 
    data.frame(result_json$answers$subject_information) %>% 
      mutate(workerid = i,
             language = gsub("\"", "", language),
         enjoyment = gsub("\"", "", enjoyment),
         age = gsub("\"", "", age),
         gender = gsub("\"", "", gender),
         problems = gsub("\"", "", problems),
         comments = gsub("\"", "", comments))
  )
  
  df.trials = bind_rows(
    df.trials, 
    data.frame(result_json$answers$trials) %>% 
      mutate(workerid = i,
             combined_predicate = ifelse(!is.na(combined_predicate), combined_predicate, combined_precidate)) %>%
      select(workerid, kind, predicate1, predicate2, combined_predicate, trial_type, condition, response)
  )

  i = i + 1
}
```


```{r}
df.subject %>%
  select(workerid, language, enjoyment, age, gender, problems, comments) %>%
  kable(.)
```

## Attention Checks 

### Slider Practice

Before the experiment, participants practice using the sliders to rate 3 sentences:

- Anna laughed on Jon. (coded as correct if x < 0.5)
- The train from Edmonton to Orlando was late. (coded as correct if x > 0.5)
- The burning candle spelled wrong. (coded as correct if x < 0.5)

Most participants judged the third sentence to be acceptable, so we don't exclude any participants who did so.
```{r}
df.attention %>%
  filter(condition == "practice", sentence == "The burning candle spelled wrong.") %>%
  ggplot(aes(x = response)) +
    geom_histogram() +
    labs(title = "Acceptability Ratings for 'The burning candle spelled wrong.'",
         x = "Acceptability Rating",
         y = "Number of Participants")
```

```{r}
df.slider_check <- df.attention %>% 
  filter(condition == "practice") %>%
  mutate(correct = case_when(
    sentence == "Anna laughed on Jon." ~ response < 0.5,
    sentence == "The train was late this morning." ~ response > 0.5,
    sentence == "The burning candle spelled wrong." ~ TRUE
  )) 

df.slider_check.workers <- df.slider_check %>%
  group_by(workerid) %>% 
  summarize(
    n_correct = sum(correct),
    not_all_correct = n_correct < 3
  )

workers.fail.sliders <- df.slider_check.workers %>%
  filter(not_all_correct) %>%
  pull(workerid)

# number of participants that got a certain number of properties correct
df.slider_check %>% 
  group_by(workerid) %>%
  summarize(n_correct = sum(correct)) %>%
  group_by(n_correct) %>% count() %>%
  kable()

# number of participants that got each property correct
df.slider_check %>% 
  group_by(sentence) %>%
  summarize(n_correct = sum(correct, na.rm = TRUE)) %>%
  kable()
```

### Memory Check

After the story, participants select statements they recall seeing from a list of 10 (5 true, 5 distractor).

```{r}
df.mmry <- df.attention %>%
  filter(condition == "memory_check") %>%
  mutate(correct = as.numeric(correct)) %>%
  group_by(workerid, tested_on) %>%
  summarize(n_correct = sum(correct)) %>%
  ungroup() %>%
  spread(tested_on, n_correct) %>%
  rename(correct_rejections = `0`, 
         hits = `1`) %>%
  mutate(n_correct = correct_rejections + hits) 

workers.fail.memory <- df.mmry %>% filter(n_correct < 7) %>% pull(workerid)

ggplot(df.mmry, aes(x = n_correct))+
  geom_bar()+
  xlab("Number of Statements Correctly Recognized (or Correctly Rejected)")+
  scale_x_continuous(limits = c(0, 10.5), breaks = c(0, 4, 5, 6, 7, 8, 9, 10))+
  ylab("Number of Participants")
```

### Explanations of Task

After the story, participants are also asked to explain generally what they did in the experiment.

```{r}
df.expln <- df.attention %>%
  filter(correct == -1) %>%
  left_join(., df.mmry %>% select(workerid, n_correct) %>%
              rename(n_memory_correct = n_correct)) %>%
  left_join(., df.slider_check.workers %>% select(workerid, n_correct) %>%
              rename(n_slider_correct = n_correct))

bad.expln <- c()

df.expln %>%
  select(workerid,n_slider_correct,  n_memory_correct, property) %>%
  rename(explanation = property) %>%
  kable(.)
```

## Participants

### Included/Excluded Subject Numbers
Removing participants who didn't get the first two sliders and who answered less than 7 of the memory check questions correctly.

```{r}
df.trials <- df.trials %>%
  mutate(memory_fail = workerid %in% workers.fail.memory,
      slider_fail = workerid %in% workers.fail.sliders,
      bad_expln  = workerid %in% bad.expln) %>%
  left_join(., 
      df.mmry %>% select(workerid, n_correct)
)

df.trials %>%
  distinct(workerid, memory_fail, slider_fail, bad_expln) %>%
  mutate(include = !memory_fail & !slider_fail) %>%
  group_by(memory_fail, slider_fail, include) %>% count() %>% kable()

df.query <- df.trials %>%
  filter(!memory_fail, !slider_fail) %>%
  rename(quantifier = trial_type, coordination = condition) %>%
  mutate(quantifier = factor(quantifier, levels = c("generic", "most", "all"), ordered = TRUE))
```

### Number of Participants by Item and Condition

```{r}
df.full.tab.item.count <- df.query %>%
  group_by(coordination, quantifier, combined_predicate) %>%
  count() %>%
  spread(quantifier, n)

df.full.tab.item.count %>% kable()

df.full.tab.item.count %>% 
  gather(quantifier, n, all, generic, most) %>%
  group_by(coordination) %>%
  summarize(n = sum(n)) %>% kable()
```

### Acceptability Judgements by Participant
 
Histogram of all of a single participant's acceptability judgements, collapsed across trials and color coded for the number of correct responses on the memory check.  
* fill = number of correct responses on the memory check (out of 10)  
* facet = participants  

```{r fig.height = 10}
df.query %>%
  ggplot(., aes( x = response, fill = n_correct ))+
  geom_histogram()+
  facet_wrap(~workerid)+
  scale_fill_viridis()+
  scale_x_continuous(breaks = c(0, 0.5, 1)) +
  ylab("Number of Judgements") +
  xlab("Acceptability Rating")
```

## Histograms of Acceptability Judgements by Coordination and Quantifier (collapsed across item)

```{r fig.height = 8}
df.query %>%
  ggplot(aes( x = response ))+
  geom_histogram()+
  facet_grid(coordination ~ quantifier) +
  xlab("Acceptability Rating") +
  ylab("Number of Trials")
```

### Pirate Plots by Coordination and Quantifier (collapsed across item)

```{r}
df.bs <- df.query %>%
  group_by(quantifier, coordination) %>%
  tidyboot_mean(column = response)
  
ggplot(df.bs, aes( x = quantifier))+
  theme_black()+
  scale_fill_manual(values=c("#f4424e", "#4049f7", "#40f3f9")) +
  scale_color_manual(values=c("#f4424e", "#4049f7", "#40f3f9")) +
  geom_jitter(data = df.query,
             inherit.aes = F, aes(x = quantifier, y = response, color = quantifier), 
             alpha = 0.5)+
  geom_col(position = position_dodge(0.8),
           aes(y = mean, fill = quantifier),
           width = 0.8, alpha = 0.3, color = 'white')+
  geom_linerange(aes(ymin = ci_lower, ymax = ci_upper), 
                position = position_dodge(0.8),  size = 1.2, color = 'white')+  
  ylab("Acceptability Rating")+
  facet_wrap(~coordination)+
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1))+
  xlab("")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
        legend.position = "top")+
  guides(fill = F, color = F)

ggsave("~/Documents/talks/1904-bochum-elephants/expt4_acceptability.pdf",
       width = 6, height = 4)
```

## Generic VP Analysis

```{r}
df.generic.vp <- df.query %>%
  filter(quantifier == "generic", coordination == "vp") %>%
  mutate(response = response - 0.5)
generic.vp.model <- lmer(response ~ 1 + (1 | workerid) + (1 | combined_predicate),
                         data = df.generic.vp)
summary(generic.vp.model)
```

## By-item Analyses

### Number of Trials by Item and Quantifier

```{r}
df.tab.item.count <-  df.query %>%
  group_by(coordination, quantifier) %>%
  count() %>%
  spread(quantifier, n) 

df.tab.item.count %>% kable()

df.tab.item.count %>% 
  gather(quantifier, n, all, generic, most) %>%
  group_by(quantifier) %>%
  summarize(n = sum(n)) %>% kable()
```

## Pirate Plots (by item)

```{r fig.width=13, fig.height = 30}
df.bs.item <- df.query %>%
  group_by(coordination, quantifier, combined_predicate) %>%
  tidyboot_mean(column = response)

ggplot(df.bs.item, aes( x = quantifier, fill = quantifier))+
  scale_color_manual(values=c("#f4424e", "#4049f7", "#40f3f9")) +
  geom_hline(yintercept = 0.5, lty = 2, alpha = 0.5)+
  geom_linerange(aes(ymin = ci_lower, ymax = ci_upper), 
                position = position_dodge(0.8), width = 0.3, size = 1, alpha = 0.5)+  
  geom_point(data = df.query, 
             position = position_jitterdodge(),
             inherit.aes = F, aes(x = quantifier, y = response, color = quantifier), 
             alpha = 0.8)+
  ylab("Acceptability Rating")+
  facet_wrap(~combined_predicate + coordination, ncol = 4)+
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1))+
  xlab("")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
        legend.position = "top")
```

### Confidence Intervals (by item)

```{r fig.height = 15}
ggplot(df.bs.item, aes(x = combined_predicate, color = quantifier)) +
  scale_color_manual(values=c("#f4424e", "#4049f7", "#40f3f9")) +
  geom_pointrange(aes(y = mean, ymin = ci_lower, ymax = ci_upper),
                 position = position_dodge(0.6)) +
  facet_wrap(~coordination) +
  xlab("Item") +
  ylab("Acceptability Rating") +
  coord_flip()
```

### Histograms of Acceptability Ratings by Item

### by Coordination

```{r fig.height = 20}
df.query %>%
  ggplot(., aes( x = response ))+
  geom_histogram()+
  facet_grid( combined_predicate ~coordination, scales = 'free')+
  theme(strip.text.y = element_text(angle = 0))
```

### by Quantifier

```{r fig.height = 20}
df.query %>%
  ggplot(., aes( x = response ))+
  geom_histogram()+
  facet_grid( combined_predicate ~quantifier, scales = 'free')+
  theme(strip.text.y = element_text(angle = 0))
```