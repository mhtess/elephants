---
title: "elephants-8-pilot"
author: "MH Tessler"
date: "2/22/2019"
output: github_document
---

[Link to experiment (all condition)](https://www.mit.edu/~karengu/elephants_all/elephants/experiments/elephants-8.html)

### Experiment 8 pilot

- VP coordination 
- most vs. all vs. some

All questions interrupting.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F, fig.width = 10)
library(tidyverse)
library(knitr)
library(ggthemes)
library(jsonlite)
library(viridis)
library(tidyboot)
library(ggpirate)
theme_set(theme_few())
project.path <- "~/projects/elephants/"
expt.prefix <- "elephants-8"
data.path <- paste("../data", expt.prefix,sep = "/")
fig.path <- paste(project.path, "writing/cogsci2019/figs/", sep = "")
```

### Subject information

```{r, echo=F, warning=F}
results.path <- paste(project.path, data.path, sep = "/")
anon_results = list.files(data.path)

i = 0
df.subject <- data.frame()
df.trials <- data.frame()
df.attention <- data.frame()
for (anon_result in anon_results) {
  
  result_json = fromJSON(paste(data.path, anon_result, sep ="/"))

  df.attention = bind_rows(
    df.attention, 
    data.frame(result_json$answers$catch_trials) %>%
    mutate(
      workerid = i
      )
  )
  
  df.subject = bind_rows(
    df.subject, 
    data.frame(result_json$answers$subject_information) %>% 
      mutate(workerid = i)
  )
  
  df.trials = bind_rows(
    df.trials, 
    data.frame(result_json$answers$trials) %>% 
      mutate(workerid = i)
  )

  i = i + 1
}
```


```{r}
df.subject %>%
  select(workerid, language, enjoyment, age, gender, problems, comments) %>%
  kable(.)
```

## Attention check 

### Slider practice

Before the experiment, participants practice usign the sliders to rate 3 category--property pairs:

- dogs bark (coded as correct if x > 0.5)
- birds are male (coded as correct if 0.25 < x < 0.75)
- cats get cancer (coded as correct if x < 0.75) [being generous with this one]
- lions lay eggs (coded as correct if x < 0.10)

```{r}

# slider bar check

df.slider_check <- df.attention %>% 
  filter(condition == "practice") %>%
  mutate(correct = case_when(
    property == "dogs bark" ~ response > 0.5,
    property == "birds are male" ~ response > 0.25 & response < 0.75,
    property == "cats get cancer" ~ response < 0.75,
    property == "lions lay eggs" ~ response < 0.3
  )) 

df.slider_check.workers <- df.slider_check %>%
  group_by(workerid) %>% 
  summarize(
    n_correct = sum(correct),
    not_all_correct = n_correct < 4,
    not_three_correct = n_correct < 3
    )

workers.fail.sliders <- df.slider_check.workers %>%
  filter(not_all_correct) %>%
  pull(workerid)

# worker 44 failed to respond to last slider, but they got wrong one other slider
workers.fail.sliders <- c(workers.fail.sliders, 44)

df.slider_check %>% 
  group_by(workerid) %>%
  summarize(n_correct = sum(correct)) %>%
  group_by(n_correct) %>% count() %>%
  kable()

df.slider_check %>% 
  group_by(property) %>%
  summarize(n_correct = sum(correct, na.rm = TRUE)) %>%
  kable()
```


### Memory check

After the story, participants select statements they recall learning from a list of 10 generic statements about novel animals (5 true, 5 distractor). They are also asked to explain what they did in the experiment.


```{r}
# memory check data
df.mmry <- df.attention %>%
  filter(condition == "memory_check") %>%
  mutate(correct = as.numeric(correct)) %>%
  #filter(correct != -1) %>% # remove explanations
  group_by(workerid, tested_on) %>%
  summarize(n_correct = sum(correct)) %>%
  ungroup() %>%
  spread(tested_on, n_correct) %>%
  rename(correct_rejections = `0`, 
         hits = `1`) %>%
  mutate(n_correct = correct_rejections + hits) 

#workers.fail.memory <- df.mmry %>% filter(n_correct < 7) %>% pull(workerid)
workers.fail.memory <- c()#df.mmry %>% filter(correct_rejections < 4) %>% pull(workerid)

ggplot(df.mmry, aes( x = correct_rejections ))+
  geom_bar()+
  #xlab("n correctly recognized (or correctly rejected)")+
  #scale_x_continuous(limits = c(0, 10.5), breaks = c(0, 4, 5, 6, 7, 8, 9, 10))+
  ylab("n participants")

#df.mmry %>%
# kable(.)

```


### Explanations of task

```{r}
df.expln <- df.attention %>%
  filter(correct == -1) %>%
  left_join(., df.mmry %>% select(workerid, n_correct) %>%
              rename(n_memory_correct = n_correct)) %>%
  left_join(., df.slider_check.workers %>% select(workerid, n_correct) %>%
              rename(n_slider_correct = n_correct))

bad.expln <- c()
df.expln %>%
  select(workerid,n_slider_correct,  n_memory_correct, property) %>%
  rename(explanation = property) %>%
  kable(.)
```

Memory check questions seem off:
```{r}
length(unique(c(workers.fail.memory, workers.fail.sliders, bad.expln)))
```
## Trial data

Check number of participants per condition

```{r}
df.full.tab.item.count <-  df.trials %>% filter(condition ==  "uninterrupted", trial_type == "critical", page_type == "query") %>%
  group_by(quantifier, predicate_1) %>%
  count() %>%
  spread(quantifier, n) 


df.full.tab.item.count %>% kable()

df.full.tab.item.count %>% 
  gather(quantifier, n, all, generic, most) %>%
  group_by(quantifier) %>%
  summarize(n = sum(n)) %>% kable()
```


Removing participants who got fewer than 7 correct on memory check and didn't get all 4 sliders.

```{r}
df.trials <- df.trials %>%
  mutate(memory_fail = workerid %in% workers.fail.memory,
      slider_fail = workerid %in% workers.fail.sliders,
      bad_expln  = workerid %in% bad.expln) %>%
  left_join(., 
      df.mmry %>% select(workerid, n_correct)
)


df.query <- df.trials %>%
  filter(page_type == "query") %>%
  gather(key, val, response_1, response_2)
```

Included/excluded subject numbers

```{r}
df.query %>%
  distinct(workerid, memory_fail, slider_fail, bad_expln) %>%
  group_by(memory_fail, slider_fail) %>% count() %>% kable()
```


## participant responses
 
collapsed across trials

- fill = number of correct responses on the memory check (out of 10)
- facet = particiapnts

```{r fig.height = 10}
df.query  %>%
  ggplot(., aes( x = val, fill = n_correct ))+
  geom_histogram()+
  facet_wrap(~workerid)+
  scale_fill_viridis()+
  scale_x_continuous(breaks = c(0, 0.5, 1))
```

## filler trials

these used quantifiers (and thus we have strong idea about literal meaning)

```{r}
df.query.filler <- df.query %>%
  filter(!memory_fail, !slider_fail) %>%
  #filter(!slider_fail, !bad_expln) %>%
  filter(trial_type == "filler") %>%
  select(workerid, condition, chapter_num, 
         rt, trial_type, quantifier, page_type, key, val)

df.query.filler  %>%
  ggplot(., aes( x = val ))+
  geom_histogram()+
  facet_wrap(~quantifier + condition)
```

```{r fig.height = 10}
df.query.critical <- df.query %>%
  filter(!memory_fail, !slider_fail) %>%
  select(workerid, condition, chapter_num, rt, 
         quantifier,
         trial_type, predicate_1, predicate_2, 
         key, val, page_type, memory_fail, slider_fail) %>%
  filter(trial_type == "critical") %>%
  rowwise() %>%
  mutate(condition = factor(condition, 
                            levels = c("interrupted", 
                                       "uninterrupted",
                                       "nme_interrupted",
                                       "nme_uninterrupted"),
                            labels = c('"...live in Africa __"\nQ2(Asia)',
                                       '"...live in Africa and Asia"\nQ2(Asia)',
                                       '"...live in Africa __"\nQ2(bugs)',
                                       '"...live in Africa and eat bugs"\nQ2(bugs)')),
         key = factor(key, levels = c("response_1", "response_2"),
                      labels = c("% live in Africa", "% property 2")))

df.query.critical %>%
  ggplot(., aes( x = val ))+
  geom_histogram()+
  facet_grid(quantifier + condition ~ key)

unique(df.query.critical$condition)
```


```{r}
df.bs.query.critical <- df.query.critical %>%
  group_by(quantifier, condition, key) %>%
  tidyboot_mean(column = val)

bind_rows(
  df.bs.query.critical %>%
  filter(condition %in% c("\"...live in Africa __\"\nQ2(Asia)",
                          "\"...live in Africa and Asia\"\nQ2(Asia)")) %>%
  mutate(second_query = "% live in Asia"),
  df.bs.query.critical %>%
    filter(!(condition %in% c("\"...live in Africa __\"\nQ2(Asia)",
                            "\"...live in Africa and Asia\"\nQ2(Asia)"))) %>%
    mutate(second_query = "% eat bugs")
)
  
ggplot(df.bs.query.critical, aes( x = condition, fill = key))+
  geom_hline(yintercept = 0.5, lty = 2, alpha = 0.5)+
  geom_point(data = df.query.critical, position = position_jitterdodge(),
             inherit.aes = F, aes(x = condition, y = val, color = key), 
             alpha = 0.5)+
  geom_col(position = position_dodge(0.8),
           aes(y = mean),
           width = 0.8, alpha = 0.3, color = 'black')+
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), 
                position = position_dodge(0.8), width = 0.3, size = 1.2)+  
  ylab("Implied prevalence rating")+
  facet_wrap(~quantifier)+
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1))+
  scale_fill_manual(values = c("#268bd2", "#859900"))+
  scale_color_manual(values = c("#268bd2", "#859900"))+
  xlab("")+
  guides(fill = guide_legend(title = "Question"),
         color = guide_legend(title = "Question"))+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
        legend.position = "top")

#ggsave(paste(fig.path, "quantifierPilot_summary.pdf", sep = ""), 
#       height = 4.5, width = 10)
```



```{r}
df.query.critical %>%
  filter(#quantifier %in% c("most", "generic",),
         condition ==  "\"...live in Africa and Asia\"\nQ2(Asia)") %>%
  ggplot(., aes( x = val ))+
  geom_histogram()+
  facet_grid( condition+ quantifier~ key, scales = 'free')+
  theme(strip.text.y = element_text(angle = 0))

#ggsave(paste(fig.path, "quantifierPilot_criticalHists_summary.pdf", sep = ""), 
#       height = 4.5, width = 10)
```

# By-item analysis


```{r}
df.tab.item.count <-  df.query.critical %>% filter(condition ==  "\"...live in Africa and Asia\"\nQ2(Asia)", str_detect(key, "Africa")) %>%
  group_by(quantifier, predicate_1) %>%
  count() %>%
  spread(quantifier, n) 


df.tab.item.count %>% kable()

df.tab.item.count %>% 
  gather(quantifier, n, all, generic, most) %>%
  group_by(quantifier) %>%
  summarize(n = sum(n)) %>% kable()
```


## Pirate plots by item

```{r}
ggplot(df.bs.cond2.item, aes( x = quantifier, fill = key))+
  geom_hline(yintercept = 0.5, lty = 2, alpha = 0.5)+
  # geom_col(position = position_dodge(0.8),
  #          aes(y = mean),
  #          width = 0.8, alpha = 0.3, color = 'black')+
  # geom_linerange(aes(ymin = ci_lower, ymax = ci_upper), 
  #               position = position_dodge(0.8), width = 0.3, size = 1, alpha = 0.5)+  
  geom_point(data = df.query.critical %>% filter(condition ==  "\"...live in Africa and Asia\"\nQ2(Asia)"), 
             position = position_jitterdodge(),
              #position = position_dodge(0.5),
             inherit.aes = F, aes(x = quantifier, y = val, color = key), 
             alpha = 0.8)+
  ylab("Implied prevalence rating")+
  facet_wrap(~predicate_1, nrow = 2)+
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1))+
  scale_fill_manual(values = c("#268bd2", "#859900"))+
  scale_color_manual(values = c("#268bd2", "#859900"))+
  xlab("")+
  guides(fill = guide_legend(title = "Question"),
         color = guide_legend(title = "Question"))+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
        legend.position = "top")
# ggsave(paste(fig.path, "quantifierPilot_byItemPoints.pdf", sep = ""),
#       height = 6, width = 12)

```


```{r fig.width=13}
df.bs.cond2.item <- df.query.critical %>%
  filter(#quantifier %in% c("most", "generic",),
         condition ==  "\"...live in Africa and Asia\"\nQ2(Asia)") %>%
  group_by(quantifier, condition, predicate_1, key) %>%
  tidyboot_mean(column = val)


ggplot(df.bs.cond2.item, aes( x = key, fill = key))+
  geom_hline(yintercept = 0.5, lty = 2, alpha = 0.5)+
  # geom_col(position = position_dodge(0.8),
  #          aes(y = mean),
  #          width = 0.8, alpha = 0.3, color = 'black')+
  # geom_linerange(aes(ymin = ci_lower, ymax = ci_upper), 
  #               position = position_dodge(0.8), width = 0.3, size = 1, alpha = 0.5)+  
  geom_point(data = df.query.critical %>% filter(condition ==  "\"...live in Africa and Asia\"\nQ2(Asia)"), 
             #position = position_jitterdodge(),
              #position = position_dodge(0.5),
             inherit.aes = F, aes(x = key, y = val, color = key), 
             alpha = 0.8)+
  geom_line(data = df.query.critical %>% filter(condition ==  "\"...live in Africa and Asia\"\nQ2(Asia)"), 
           #  position = position_jitterdodge(),
            position = position_dodge(),
             inherit.aes = F, aes(x = key, y = val, group = workerid), 
             alpha = 0.6)+
  ylab("Implied prevalence rating")+
  facet_wrap(~predicate_1 + quantifier, ncol = 9)+
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1))+
  scale_fill_manual(values = c("#268bd2", "#859900"))+
  scale_color_manual(values = c("#268bd2", "#859900"))+
  xlab("")+
  guides(fill = guide_legend(title = "Question"),
         color = guide_legend(title = "Question"))+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
        legend.position = "top")


# ggsave(paste(fig.path, "quantifierPilot_byItem_bySubjLines.pdf", sep = ""),
#       height = 8, width = 12)
```

