---
title: "elephants-5-pilot"
author: "MH Tessler"
date: "1/28/2019"
output: github_document
---

[Link to experiment](http://www.mit.edu/~tessler/projects/elephants/experiments/elephants-6.html)


### Experiment 6 pilot

All questions interrupting.

- int1: (Africa) -- Q(Af, As) -- (and eat bugs in the wild)
- int2: (Africa and) -- Q(Af, As) -- (eat bugs in the wild)
- int4: (Africa and Asia) -- Q(Af, As) -- (which is warm)


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
library(tidyverse)
library(knitr)
library(ggthemes)
library(viridis)
library(tidyboot)
library(ggpirate)
theme_set(theme_few())
project.path <- "~/projects/elephants/"
expt.prefix <- "elephants-6"
data.path <- paste("mturk", expt.prefix,sep = "/")
```

### Subject information

```{r}
df.subj <- read_csv(
  paste(project.path, data.path, "/", 
        expt.prefix, "-subject_information.csv", sep = "")
  ) %>%
  mutate(language = gsub("\"", "", language),
         enjoyment = gsub("\"", "", enjoyment),
         age = gsub("\"", "", age),
         gender = gsub("\"", "", gender),
         problems = gsub("\"", "", problems),
         comments = gsub("\"", "", comments))

df.subj %>%
  select(workerid, language, enjoyment, age, gender, problems, comments) %>%
  kable(.)
```

## Attention check 

### Slider practice

Before the experiment, participants practice usign the sliders to rate 3 category--property pairs:

- dogs bark (coded as correct if x > 0.5)
- birds are male (coded as correct if 0.25 < x < 0.75)
- cats get cancer (coded as correct if x < 0.75) [being generous with this one]
- lions lay eggs (coded as correct if x < 0.10)

```{r}
df.attn <- read_csv(
  paste(project.path, data.path, "/", 
        expt.prefix, "-catch_trials.csv", sep = "")
  ) %>%
  mutate(property = gsub("\"", "", property),
         condition = gsub("\"", "", condition))

# slider bar check

df.slider_check <- df.attn %>% 
  filter(condition == "practice") %>%
  mutate(correct = case_when(
    property == "dogs bark" ~ response > 0.5,
    property == "birds are male" ~ response > 0.25 & response < 0.75,
    property == "cats get cancer" ~ response < 0.75,
    property == "lions lay eggs" ~ response < 0.1
  )) 

df.slider_check.workers <- df.slider_check %>%
  group_by(workerid) %>% 
  summarize(
    n_correct = sum(correct),
    not_all_correct = n_correct < 4,
    not_three_correct = n_correct < 3
    )

workers.fail.sliders <- df.slider_check.workers %>%
  filter(not_all_correct) %>%
  pull(workerid)

df.slider_check %>% 
  group_by(workerid) %>%
  summarize(n_correct = sum(correct)) %>%
  group_by(n_correct) %>% count() %>%
  kable()

df.slider_check %>% 
  group_by(property) %>%
  summarize(n_correct = sum(correct)) %>%
  kable()
```


### Memory check

After the story, participants select statements they recall learning from a list of 10 generic statements about novel animals (5 true, 5 distractor). They are also asked to explain what they did in the experiment.



```{r}
# memory check data
df.mmry <- df.attn %>%
  filter(condition == "memory_check") %>%
  mutate(correct = as.numeric(correct)) %>%
  #filter(correct != -1) %>% # remove explanations
  group_by(workerid, tested_on) %>%
  summarize(n_correct = sum(correct)) %>%
  ungroup() %>%
  spread(tested_on, n_correct) %>%
  rename(correct_rejections = `0`, 
         hits = `1`) %>%
  mutate(n_correct = correct_rejections + hits) 

workers.fail.memory <- df.mmry %>% filter(n_correct < 7) %>% pull(workerid)

ggplot(df.mmry, aes( x = n_correct ))+
  geom_bar()+
  xlab("n correctly recognized (or correctly rejected)")+
  scale_x_continuous(limits = c(0, 10.5), breaks = c(0, 4, 5, 6, 7, 8, 9, 10))+
  ylab("n participants")

#df.mmry %>%
# kable(.)

```


### Explanations of task

```{r}
df.expln <- df.attn %>%
  filter(correct == -1) %>%
  left_join(., df.mmry %>% select(workerid, n_correct) %>%
              rename(n_memory_correct = n_correct)) %>%
  left_join(., df.slider_check.workers %>% select(workerid, n_correct) %>%
              rename(n_slider_correct = n_correct))

bad.expln <- c(11, 19,22, 26)
df.expln %>%
  select(workerid,n_slider_correct,  n_memory_correct, property) %>%
  rename(explanation = property) %>%
  kable(.)
```



Memory check questions seem off:
```{r}
unique(c(bad.expln, workers.fail.sliders))
```
## Trial data

Removing participants who got fewer than 7 correct on memory check and didn't get all 4 sliders.

```{r}
df.trials <- left_join(
    read_csv(
    paste(project.path, data.path, "/", 
          expt.prefix, "-trials.csv", sep = "")
    ) %>% 
    mutate(
      page_type = gsub("\"", "", page_type),
      trial_type = gsub("\"", "", trial_type),
      kind = gsub("\"", "", kind),
      #generic = gsub("\"", "", generic),
      page_content = gsub("\"", "", page_content),
      predicate_1 = gsub("\"", "", predicate_1),
      predicate_2 = gsub("\"", "", predicate_2),
      #verb = gsub("\"", "", verb),
      chapter = gsub("\"", "", chapter),
      condition = gsub("\"", "", condition),
      quantifier = gsub("\"", "", quantifier),
      memory_fail = workerid %in% workers.fail.memory,
      slider_fail = workerid %in% workers.fail.sliders,
      bad_expln  = workerid %in% bad.expln
      ),
    df.mmry %>% select(workerid, n_correct)
)

df.query <- df.trials %>%
  filter(page_type == "query") %>%
  gather(key, val, response_1, response_2)
```

Included/excluded subject numbers

```{r}
df.query %>%
  distinct(workerid, memory_fail, slider_fail) %>%
  group_by(memory_fail, slider_fail) %>% count() %>% kable()
```


## participant responses
 
collapsed across trials

- fill = number of correct responses on the memory check (out of 10)
- facet = particiapnts

```{r}
df.query  %>%
  ggplot(., aes( x = val, fill = n_correct ))+
  geom_histogram()+
  facet_wrap(~workerid)+
  scale_fill_viridis()+
  scale_x_continuous(breaks = c(0, 0.5, 1))
```

## filler trials

these used quantifiers (and thus we have strong idea about literal meaning)

```{r}
df.query.filler <- df.query %>%
  filter(!memory_fail, !slider_fail) %>%
  #filter(!slider_fail, !bad_expln) %>%
  filter(trial_type == "filler") %>%
  select(workerid, condition, chapter_num, 
         rt, trial_type, quantifier, page_type, key, val)

df.query.filler  %>%
  ggplot(., aes( x = val ))+
  geom_histogram()+
  facet_wrap(~quantifier + condition)
```

## critical trials (collapsed across item)

*Conditions*

1. AF: "Elephants live in Africa" -- Q(Africa, Asia) -- "and breathe oxygen"
2. AF&: "Elephants live in Africa and" -- Q(Africa, Asia) -- "breathe oxygen"
4. AF&AS: "Elephants live in Africa and Asia" -- Q(Africa, Asia) -- "while alive"

### N's per condition

```{r}
df.query.critical <- df.query %>%
  filter(!memory_fail, !slider_fail) %>%
  #filter(!bad_expln, !slider_fail) %>%
  select(workerid, condition, chapter_num, rt, 
         trial_type, predicate_1, predicate_2, 
         key, val, page_type, memory_fail, slider_fail, bad_expln) %>%
  filter(trial_type == "critical") %>%
  rowwise() %>%
  mutate(condition = ifelse(condition %in% c("before", "after"),
                            "AF&AS_unint", condition),
    condition = factor(condition, 
                            levels = c("int1", 
                                       "int2",
                                       #"int3",
                                       "int4",
                                       "AF&AS_unint"),
                            labels = c('"...live in Africa __"',
                            '"...live in Africa and __"',
                                       '"...live in Africa and Asia __"',
                                       '"...live in Africa and Asia."')
                         # c("AF",
                         #               "AF&", #"AF&B",
                         #               "AF&AS", 
                         #               "AF&AS_unint",
                         #               "AF&AS_unint2"
                         #               )
  ),
         key = factor(key, levels = c("response_1", "response_2"),
                      labels = c("% live in Africa", "% live in Asia")))

df.query.critical %>% 
  filter(key == "% live in Africa") %>%
  group_by(condition) %>% count() %>% kable()
```

```{r}

df.query.critical %>%
  ggplot(., aes( x = val ))+
  geom_histogram()+
  facet_grid(key~condition)

#unique(df.query.critical$condition)
```

#### bootstrapped 95% confidence intervals

_Property 2_ = "% live in Asia" for all but the NME (non mutually exclusive) trials

```{r}
df.bs.query.critical <- df.query.critical %>%
  group_by(condition, key) %>%
  tidyboot_mean(column = val)

df.bs.query.critical %>%
  ggplot(., aes( x = condition, fill = key))+
  geom_hline(yintercept = 0.5, lty = 2, alpha = 0.5)+
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), 
                position = position_dodge(0.8), width = 0.3, size = 1.2)+  
  geom_point(data = df.query.critical, position = position_jitterdodge(),
             inherit.aes = F, aes(x = condition, y = val, color = key), 
             alpha = 0.5)+
  geom_col(position = position_dodge(0.8),
           aes(y = mean),
           width = 0.8, alpha = 0.3, color = 'black')+
  ylab("Implied prevalence rating")+
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1))+
  scale_fill_solarized()+
  scale_color_solarized()+
  xlab("")+
  guides(fill = guide_legend(title = "Question"),
         color = guide_legend(title = "Question"))+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.55, hjust = 0.5),
        legend.position = "top")


#ggsave(paste(fig.path, "expt3_summary.pdf", sep = ""),  height = 4.5, width = 5.5)
```


```{r}
df.query.critical %>% spread(key, val) %>% 
  rename(africa = `% live in Africa`,
         asia = `% live in Asia`) %>%
  rowwise() %>%
  mutate(ME = africa + asia < 1.05,
         af_g_as = africa > asia,
         universal_af = africa > 0.9,
         universal_as = asia > 0.9) %>%
  gather(key, val, ME, af_g_as, universal_af, universal_as) %>%
  group_by(condition, key) %>%
  tidyboot_mean(column = val) %>%
  ggplot(., aes( x = condition, fill = key))+
  geom_hline(yintercept = 0.5, lty = 2, alpha = 0.5)+
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), 
                position = position_dodge(0.8), width = 0.3, size = 1.2)+  
  geom_col(position = position_dodge(0.8),
           aes(y = mean),
           width = 0.8, alpha = 0.3, color = 'black')+
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1))+
  scale_fill_solarized()+
  scale_color_solarized()+
  xlab("")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.55, hjust = 0.5),
        legend.position = "top")
```


#### pirate plots

```{r}
df.query.critical %>%
  #filter(condition %in% c("AF","AF&","AF&AS")) %>% 
  ggplot(., aes( x = condition, y = val))+
  geom_pirate(aes(color = key, fill = key),
              violins = F, show.legend = TRUE)+
  #geom_col(position = position_dodge(0.8), width = 0.8, alpha = 0.8, color = 'black')+
  ylab("% Africa")+
  #geom_errorbar(position = position_dodge(0.8), width = 0.3)+
  scale_fill_solarized()+
  scale_color_solarized()+
  scale_y_continuous(breaks = c(0, 0.5, 1))+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

### By-item averages

N's per item X condition

```{r}
df.query.critical %>%
  filter(!memory_fail, !slider_fail) %>%
  ungroup() %>%
  group_by(condition, predicate_1, predicate_2) %>%
  count() %>%
  spread(condition, n) %>% kable()
```

### Pirate plots

```{r fig.width = 12}
df.bs.query.critical.item <- df.query.critical %>%
  group_by(condition, key, predicate_1, predicate_2) %>%
  tidyboot_mean(column = val)

df.bs.query.critical.item %>%
  ggplot(., aes( x = condition, fill = key))+
  geom_hline(yintercept = 0.5, lty = 2, alpha = 0.5)+
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), 
                position = position_dodge(0.8), width = 0.3, size = 1.2)+  
  geom_point(data = df.query.critical, position = position_jitterdodge(),
             inherit.aes = F, aes(x = condition, y = val, color = key), 
             alpha = 0.5)+
  geom_col(position = position_dodge(0.8),
           aes(y = mean),
           width = 0.8, alpha = 0.3, color = 'black')+
  facet_wrap(~predicate_1 + predicate_2, nrow = 2)+
  ylab("Implied prevalence rating")+
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1))+
  scale_fill_solarized()+
  scale_color_solarized()+
  xlab("")+
  guides(fill = guide_legend(title = "Question"),
         color = guide_legend(title = "Question"))+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.55, hjust = 0.5),
        legend.position = "top")

```
## first vs. second trial (for each condition)

```{r}
df.query.critical %>%
  #filter(condition %in% c("AF","AF&","AF&AS")) %>% 
  group_by(workerid, condition, key) %>%
  mutate(first_trial  = min(chapter_num),
         last_trial = max(chapter_num),
         is_first = ifelse(chapter_num == first_trial, "first trial", 
                           "second trial")) %>%
  ggplot(., aes( x = condition, y = val))+
  geom_pirate(aes(color = key, fill = key),
              violins = F, show.legend = TRUE)+
  #geom_col(position = position_dodge(0.8), width = 0.8, alpha = 0.8, color = 'black')+
  ylab("% Africa")+
  facet_wrap(~is_first)+
  #geom_errorbar(position = position_dodge(0.8), width = 0.3)+
  scale_fill_solarized()+
  scale_color_solarized()+
  scale_y_continuous(breaks = c(0, 0.5, 1))+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

## Reaction times

*how much time do participants spend on the question slide?*

Looking only at

- AF: "Elephants live in Africa"
- AF&: "Elephants live in Africa and"
- AF&AS:  "Elephants live in Africa and Asia"

```{r}
df.query.critical %>%
  filter(key == "% live in Africa", condition %in% c("AF", "AF&", "AF&AS")) %>%
  ggplot(., aes( x = log(rt / 1000) , color = condition, fill = condition))+
  #geom_histogram(aes(y = ..density..), alpha = 0.0, position = position_dodge())+
  geom_density(aes(y = ..density..), alpha = 0.3)+
  xlab("log time in seconds")
  #facet_wrap(~condition, nrow = 2)
```

